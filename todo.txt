iOS Country Days Tracker — атомарный план (Codex-ready)
Правила выполнения (для Codex)
После каждого пункта:
отметить чекбокс как выполненный,
перечислить созданные/изменённые файлы,
кратко описать как проверить (run / UI / unit test).
Не начинать следующий пункт, пока текущий не “зелёный”.
A. Bootstrap проекта
 A1. Создать Xcode проект
Артефакт: новый SwiftUI iOS app проект (например CountryDaysTracker).
DoD: проект собирается и запускается на симуляторе без ошибок.
 A2. Структура папок
Создать группы/папки (реально в файловой системе):
App/
Models/
Services/
Storage/
Engines/
ViewModels/
Views/
Resources/
Tests/
DoD: папки существуют; проект открывается; compile ok.
 A3. Добавить Capability Background Location
Включить: Signing & Capabilities → Background Modes → Location updates
DoD: capability включён, проект собирается.
 A4. Добавить Info.plist ключи геолокации
NSLocationWhenInUseUsageDescription
NSLocationAlwaysAndWhenInUseUsageDescription
Текст: “Tracks country changes to calculate days spent per country and show them on calendar and map.”
DoD: приложение запускается; запрос разрешения не крашит.
B. Модель данных и локальное хранилище
Рекомендация: SwiftData (iOS 17+) или Core Data (если нужна совместимость). Для простоты ниже — SwiftData.
 B1. Добавить SwiftData container
Артефакт: App/CountryDaysTrackerApp.swift обновлён с ModelContainer и инъекцией в environment.
DoD: приложение компилируется.
 B2. Создать модель StayInterval
Файл: Models/StayInterval.swift
Поля:
id: UUID
countryCode: String (ISO A2)
entryAt: Date
exitAt: Date?
source: String
confidence: Double
createdAt: Date
updatedAt: Date
DoD: model компилируется, миграций не требует на старте.
 B3. Создать модель LocationEventLog (debug)
Файл: Models/LocationEventLog.swift
Поля: id, timestamp, lat, lon, source, countryCodeCandidate, accepted: Bool, note
DoD: сохраняется в SwiftData без ошибок.
 B4. Storage слой
Файл: Storage/StayRepository.swift
Методы:
fetchOpenInterval()
fetchIntervals(in range)
insertInterval(...)
closeInterval(id, exitAt)
appendLog(...)
DoD: unit-test stub (пока без тестов) + компиляция.
C. StayEngine (логика интервалов)
 C1. Создать StayEngine интерфейс
Файл: Engines/StayEngine.swift
Протокол/класс с методом:
processCountryUpdate(countryCode: String, at: Date, source: String, confidence: Double)
DoD: компилируется.
 C2. Реализовать базовую логику открытия/закрытия интервала
Правила:
если нет открытого интервала → создать
если страна та же → только updatedAt
если страна другая → закрыть текущий exitAt=at, открыть новый entryAt=at
DoD: локальный “ручной тест” через временный debug вызов из UI (кнопки).
 C3. Добавить анти-флапп “подтверждение” (API-уровень)
В StayEngine добавить опциональный callback confirmCountryChange() (пока заглушка).
DoD: код готов; подтверждение пока не подключено к CoreLocation.
D. LocationService (CoreLocation) + Geocoding
 D1. Создать LocationService skeleton
Файл: Services/LocationService.swift
NSObject, CLLocationManagerDelegate
Публичные методы:
requestPermissions()
start()
stop()
DoD: компилируется.
 D2. Реализовать запрос разрешений (WhenInUse → Always)
Логика: показать request WhenInUse, затем (по действию пользователя) request Always.
DoD: на девайсе/симуляторе появляется системный диалог.
 D3. Включить Significant Location Changes
В start() вызвать startMonitoringSignificantLocationChanges()
Обработать didUpdateLocations
DoD: приложение не падает; логирует получение локации в консоль/лог-модель.
 D4. Добавить Visits (опционально, но рекомендовано)
startMonitoringVisits()
Обработать didVisit
DoD: компиляция; события можно симулировать (если сложно — оставить за фичефлагом).
 D5. Reverse geocoding → ISO country code
Использовать CLGeocoder().reverseGeocodeLocation
Из CLPlacemark.isoCountryCode
DoD: при наличии локации получаем код страны или корректную ошибку/лог.
 D6. Подключить LocationService → StayEngine
При каждом событии (significant/visit):
получить countryCode
вызвать StayEngine.processCountryUpdate
записать LocationEventLog
DoD: ручной тест — “фейковые” кнопки симуляции страны можно убрать позже.
E. Onboarding / Permissions UI
 E1. Экран Welcome
Файл: Views/Onboarding/WelcomeView.swift
Кнопка “Continue”
DoD: приложение показывает экран при первом запуске.
 E2. Экран Permission (location)
Файл: Views/Onboarding/LocationPermissionView.swift
Кнопки:
“Allow While Using”
“Allow Always (Recommended)”
DoD: кнопки вызывают LocationService.requestPermissions() нужным способом.
 E3. Сохранение флага прохождения онбординга
@AppStorage("didOnboard")
DoD: после прохождения онбординг больше не показывается.
F. Главная навигация приложения
 F1. TabBar структура
Файл: Views/Root/RootTabView.swift
Tabs:
Calendar
Map
Stats
Settings
DoD: навигация работает, пустые экраны отображаются.
 F2. Settings экран
Файл: Views/Settings/SettingsView.swift
Пункты:
текущий статус разрешений
кнопка “Open System Settings”
debug: кнопка “Insert Test Interval” (в debug build)
DoD: экран компилируется; кнопка открывает Settings (UIApplication.openSettingsURLString).
G. Агрегации: “страна на день”, “дни по странам”, “посещённые страны”
 G1. Date utilities
Файл: Services/DateUtils.swift
Функции:
startOfDay(date)
endOfDay(date)
daysInRange(range)
DoD: unit test (простая проверка start/end).
 G2. AggregationService
Файл: Services/AggregationService.swift
Методы:
countryForDay(date, intervals) -> DayCountryResult
daysByCountry(range, intervals) -> [String:Int]
visitedCountries(range, intervals) -> Set<String>
DayCountryResult:
.single(code)
.mixed([codes]) (ограничить до 2 для UI)
.unknown
DoD: unit tests на сценарии:
один интервал на 3 дня
смена страны в середине дня
два интервала в день → mixed
 G3. ViewModel для диапазона
Файл: ViewModels/RangeSelectionViewModel.swift
Поддержка пресетов: last 30 / last 90 / this year / custom
DoD: используется на Stats и Map.
H. Calendar UI (флаги по дням)
 H1. CalendarViewModel
Файл: ViewModels/CalendarViewModel.swift
Данные:
текущий месяц
интервалы из репозитория за месяц ± буфер
мапа day → DayCountryResult
DoD: при смене месяца обновляет данные.
 H2. Calendar grid (month)
Файл: Views/Calendar/CalendarMonthView.swift
7 колонок, недели
DoD: корректно отображает сетку.
 H3. Рендер флага на ячейке дня
Файл: Views/Calendar/DayCellView.swift
Для .single(code) показать emoji-флаг (пока) + день
Для .mixed показать два маленьких флага/бейдж
DoD: данные отображаются.
 H4. Day details sheet
По тапу на день показать sheet:
список интервалов, пересекающих день
времена entry/exit (локальное)
DoD: sheet открывается, показывает данные.
I. Map UI (подсветка стран по диапазону)
 I1. Добавить GeoJSON файл границ стран
Файл: Resources/world_countries_simplified.geojson
DoD: файл добавлен в bundle, доступен.
 I2. GeoJSON parser + индекс по ISO A2
Файл: Services/CountryGeometryStore.swift
Задачи:
распарсить GeoJSON
построить map ISO_A2 -> [MKPolygon]
DoD: парсится без краша, есть количество стран в лог.
 I3. MapViewModel
Файл: ViewModels/MapViewModel.swift
Данные:
выбранный диапазон
visitedCountries set
overlays polygons
DoD: при смене диапазона обновляет overlays.
 I4. Map экран с overlays
Файл: Views/Map/VisitedCountriesMapView.swift
Использовать Map + overlay renderer через MKMapViewRepresentable (надёжнее для полигонов).
DoD: выбранные страны подсвечиваются (стандартная заливка/обводка без кастомных цветов, либо дефолт).
 I5. UI выбора диапазона на карте
Вверху: picker (presets + custom)
DoD: меняешь диапазон → подсветка меняется.
J. Stats UI (дни по странам)
 J1. StatsViewModel
Файл: ViewModels/StatsViewModel.swift
Берёт интервалы за диапазон
Считает daysByCountry
DoD: данные обновляются при смене диапазона.
 J2. Stats экран
Файл: Views/Stats/StatsView.swift
Список: флаг + код/название + дни
Сортировка: по дням desc
DoD: отображается без лагов на 1–2 года данных.
K. Полировка и надёжность
 K1. Удалить тестовые кнопки симуляции (или оставить в Debug-only)
#if DEBUG
DoD: release build без debug UI.
 K2. Экран Debug Logs (Debug-only)
Файл: Views/Debug/LogsView.swift
Показывает LocationEventLog последние 200 записей
DoD: можно быстро понять, что происходит.
 K3. “Sync on app open”
При scenePhase == .active вызвать requestLocation() (однократно, с rate limit)
DoD: при открытии обновляет текущую страну.
 K4. Минимальные edge-cases
Если geocoder вернул nil → логировать, не ломать интервалы
Если countryCode пустой → игнор
DoD: no-crash.
L. Тесты
 L1. Unit tests для StayEngine
Файл: Tests/StayEngineTests.swift
Кейсы:
create first interval
same country update
switch country closes/opens
DoD: все тесты зелёные.
 L2. Unit tests для AggregationService
Файл: Tests/AggregationServiceTests.swift
Кейсы:
single country for multiple days
mixed day
range aggregation
DoD: зелёные.

=== ПРОГРЕСС ВЫПОЛНЕНИЯ ===
Дата: 14 декабря 2025

РАЗДЕЛ A: Bootstrap проекта - ЗАВЕРШЕН ✅
- A1 ✅ Создан Xcode проект CountryDaysTracker.xcodeproj
  Файлы: CountryDaysTrackerApp.swift, ContentView.swift, Assets.xcassets
- A2 ✅ Создана структура папок
  Папки: App/, Models/, Services/, Storage/, Engines/, ViewModels/, Views/, Resources/, Tests/
- A3 ✅ Добавлен Background Location capability
  Файл: CountryDaysTracker.entitlements
- A4 ✅ Добавлены Info.plist ключи геолокации
  Файл: Info.plist с NSLocationWhenInUseUsageDescription и NSLocationAlwaysAndWhenInUseUsageDescription


РАЗДЕЛ B: Модель данных и локальное хранилище - ЗАВЕРШЕН ✅
- B1 ✅ Добавлен SwiftData container
  Файл: App/CountryDaysTrackerApp.swift (обновлен с ModelContainer)
- B2 ✅ Создана модель StayInterval
  Файл: Models/StayInterval.swift
  Поля: id, countryCode, entryAt, exitAt, source, confidence, createdAt, updatedAt
- B3 ✅ Создана модель LocationEventLog
  Файл: Models/LocationEventLog.swift
  Поля: id, timestamp, lat, lon, source, countryCodeCandidate, accepted, note
- B4 ✅ Создан Storage слой
  Файл: Storage/StayRepository.swift
  Методы: fetchOpenInterval(), fetchIntervals(), insertInterval(), closeInterval(), appendLog()

РАЗДЕЛ C: StayEngine (логика интервалов) - ЗАВЕРШЕН ✅
- C1-C3 ✅ Создан StayEngine с полной логикой
  Файл: Engines/StayEngine.swift
  Функции: 
    - processCountryUpdate() - основной метод обработки
    - Логика создания первого интервала
    - Логика обновления при той же стране
    - Логика закрытия/открытия при смене страны
    - Поддержка confirmCountryChange callback для анти-флапп

РАЗДЕЛ D: LocationService (CoreLocation) + Geocoding - ЗАВЕРШЕН ✅
- D1-D6 ✅ Создан полный LocationService
  Файл: Services/LocationService.swift
  Функции:
    - CLLocationManagerDelegate реализация
    - requestPermissions() - запрос WhenInUse → Always
    - start/stop() - управление мониторингом
    - Significant Location Changes monitoring
    - Visits monitoring
    - Reverse geocoding через CLGeocoder
    - Интеграция с StayEngine через processCountryUpdate()
    - Логирование событий через repository

РАЗДЕЛ E: Onboarding / Permissions UI - ЗАВЕРШЕН ✅
- E1-E3 ✅ Создан полный onboarding flow
  Файлы:
    - Views/Onboarding/WelcomeView.swift
    - Views/Onboarding/LocationPermissionView.swift
    - App/ContentView.swift (обновлен с @AppStorage и OnboardingFlow)
  Функции:
    - Welcome screen с описанием приложения
    - Permission screen с пошаговым запросом разрешений
    - Флаг didOnboard для сохранения состояния
    - Кнопки "Allow While Using" и "Allow Always"

РАЗДЕЛ F: Главная навигация приложения - ЗАВЕРШЕН ✅
- F1-F2 ✅ Создана TabBar структура и Settings экран
  Файлы:
    - Views/Root/RootTabView.swift (с 4 tabs: Calendar, Map, Stats, Settings)
    - Views/Settings/SettingsView.swift
    - App/ContentView.swift (обновлен для использования RootTabView после onboarding)
  Функции:
    - TabBar с навигацией между экранами
    - Settings с отображением статуса разрешений
    - Кнопка открытия системных настроек
    - Debug функции (только в DEBUG build)
    - Автоматический запуск location monitoring

РАЗДЕЛ G: Агрегации - ЗАВЕРШЕН ✅
- G1 ✅ Date utilities
  Файл: Services/DateUtils.swift
  Функции: startOfDay, endOfDay, daysInRange, dayCount
- G2 ✅ AggregationService
  Файл: Services/AggregationService.swift
  Методы: countryForDay, daysByCountry, visitedCountries
  Результат: DayCountryResult (.single/.mixed/.unknown)

РАЗДЕЛ H: Calendar UI - ЗАВЕРШЕН ✅
- H1 ✅ CalendarViewModel (месяц, загрузка интервалов, map day→result)
  Файл: ViewModels/CalendarViewModel.swift
- H2 ✅ CalendarMonthView (сетка 7 колонок)
  Файл: Views/Calendar/CalendarMonthView.swift
- H3 ✅ DayCellView (эмодзи-флаг + день)
  Файл: Views/Calendar/DayCellView.swift
- H4 ✅ Day details sheet (интервалы за день)
  Файл: Views/Calendar/DayDetailsSheet.swift

РАЗДЕЛ I: Map UI - ЗАВЕРШЕН ✅
- I1 ✅ Добавлен GeoJSON ресурс
  Файл: Resources/world_countries_simplified.geojson
- I2 ✅ CountryGeometryStore (парсинг и индекс ISO→polygons)
  Файл: Services/CountryGeometryStore.swift
- I3 ✅ MapViewModel (диапазон, visitedCountries, overlays)
  Файл: ViewModels/MapViewModel.swift
- I4 ✅ Экран карты с overlays
  Файл: Views/Map/VisitedCountriesMapView.swift
- I5 ✅ Picker пресетов диапазона
  Файл: ViewModels/RangeSelectionViewModel.swift; UI в Map view

РАЗДЕЛ J: Stats UI - ЗАВЕРШЕН ✅
- J1 ✅ StatsViewModel (считает daysByCountry по диапазону)
  Файл: ViewModels/StatsViewModel.swift
- J2 ✅ Экран Stats (список флаг + код + дни; сортировка desc)
  Файл: Views/Stats/StatsView.swift

РАЗДЕЛ K: Полировка и надёжность - ЗАВЕРШЕН ✅
- K1 ✅ Debug-only кнопки оставлены под #if DEBUG
  Файл: Views/Settings/SettingsView.swift (Insert Test Interval)
- K2 ✅ Экран Debug Logs (Debug-only)
  Файл: Views/Debug/LogsView.swift
- K3 ✅ "Sync on app open" (rate limit 15 мин)
  Файл: App/ContentView.swift (MainAppView.onChange(scenePhase))
- K4 ✅ Edge-cases: nil/empty countryCode
  Файл: Services/LocationService.swift (guard !countryCode.isEmpty)

РАЗДЕЛ L: Тесты - ЗАВЕРШЕН ✅
- L1 ✅ Unit tests для StayEngine
  Файл: Tests/StayEngineTests.swift
  Кейсы: create first interval, same country update, switch country closes/opens
- L2 ✅ Unit tests для AggregationService
  Файл: Tests/AggregationServiceTests.swift
  Кейсы: single country for multiple days, mixed day, range aggregation
  Примечание: добавлен таргет CountryDaysTrackerTests

Δ ОБНОВЛЕНИЕ: Интеграция и полировка
- F1/F2: TabBar теперь использует реальные экраны ✅
  Calendar → Views/Calendar/CalendarMonthView.swift
  Map → Views/Map/VisitedCountriesMapView.swift
  Stats → Views/Stats/StatsView.swift
  Изменено: Views/Root/RootTabView.swift
- K4: Защита от пустого ISO кода страны ✅
  Изменено: Services/LocationService.swift (guard и uppercased)

Δ ОБНОВЛЕНИЕ: Календарь и единый контейнер ✅
- Исправил “…” и пустые ячейки: DayCellView/CalendarMonthView теперь не дублируют Date.distantPast и рендерят дни/флаги без обрезки.
  Изменено: Views/Calendar/DayCellView.swift; Views/Calendar/CalendarMonthView.swift
- LocationService, OnboardingFlow, MainAppView теперь используют общий SwiftData modelContext, чтобы интервалы/флаги были общими для UI и сервиса.
  Изменено: App/ContentView.swift; Services/LocationService.swift

Δ Обновлён bundle id для сборки на девайс ✅
- Bundle ID app/tests → com.mark1ns0n.countrydays.dev / com.mark1ns0n.countrydays.devTests
  Изменено: CountryDaysTracker.xcodeproj/project.pbxproj; create_project.rb; add_test_target.rb
  Напоминание: в Xcode выбрать Personal Team (mark1ns0n), включить Automatically manage signing, Destination — ваш iPhone, доверить Developer App в Настройки → VPN & Device Management.

Технические заметки:
- Сборка в CLI может падать из‑за несовместимого CoreSimulator. Откройте проект и соберите в Xcode, либо обновите Xcode/симулятор.
- Юнит‑тесты добавлены, запуск потребует исправного симулятора.
